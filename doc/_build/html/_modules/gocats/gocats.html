<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>gocats.gocats &#8212; GOcats 1.1.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head>
  <body role="document">
      <div class="header" role="banner"><h1 class="heading"><a href="../../index.html">
          <span>GOcats 1.1.0 documentation</span></a></h1>
        <h2 class="heading"><span>gocats.gocats</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for gocats.gocats</h1><div class="highlight"><pre>
<span></span><span class="c1"># !/usr/bin/python3</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The Gene Ontology Categories Suite (GOcats)</span>
<span class="sd">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">This module provides methods for the creation of directed acyclic concept subgraphs of Gene Ontology, along with methods</span>
<span class="sd">for evaluating those subgraphs.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">ontologyparser</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">godag</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">subdag</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">tools</span>


<span class="c1"># Need a SubGraphCollection object</span>
<div class="viewcode-block" id="build_graph"><a class="viewcode-back" href="../../api.html#gocats.gocats.build_graph">[docs]</a><span class="k">def</span> <span class="nf">build_graph</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;**Not yet implemented**</span>

<span class="sd">    Try build_graph_interpreter to create a GO graph object to explore within a Python interpreter.&quot;&quot;&quot;</span>
    <span class="c1"># FIXME: JsonPickle is reaching max recursion depth because of the fact that objects point to one another.</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--supergraph_namespace&#39;</span><span class="p">]:</span>
        <span class="n">supergraph_namespace</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--supergraph_namespace&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">supergraph_namespace</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--allowed_relationships&#39;</span><span class="p">]:</span>
        <span class="n">allowed_relationships</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--allowed_relationships&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">allowed_relationships</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">database</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;database_file&gt;&#39;</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">output_directory</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;output_directory&gt;&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_directory</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_directory</span><span class="p">)</span>
    <span class="n">database_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;database_file&gt;&#39;</span><span class="p">])</span>
    <span class="n">graph_class</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go.obo&#39;</span><span class="p">:</span> <span class="n">godag</span><span class="o">.</span><span class="n">GoGraph</span><span class="p">(</span><span class="n">supergraph_namespace</span><span class="p">,</span> <span class="n">allowed_relationships</span><span class="p">)}</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">graph_class</span><span class="p">[</span><span class="n">database_name</span><span class="p">]</span>
    <span class="n">parsing_class</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go.obo&#39;</span><span class="p">:</span> <span class="n">ontologyparser</span><span class="o">.</span><span class="n">GoParser</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">graph</span><span class="p">)}</span>
    <span class="n">parsing_class</span><span class="p">[</span><span class="n">database_name</span><span class="p">]</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
    <span class="n">database</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="build_graph_interpreter"><a class="viewcode-back" href="../../api.html#gocats.gocats.build_graph_interpreter">[docs]</a><span class="k">def</span> <span class="nf">build_graph_interpreter</span><span class="p">(</span><span class="n">database_file</span><span class="p">,</span> <span class="n">supergraph_namespace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allowed_relationships</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a graph object of GO, which can be traversed and queried within a Python interpreter.</span>

<span class="sd">    :param file_handle database_file: Ontology database file.</span>
<span class="sd">    :param str supergraph_namespace: Optional - Filter graph to a sub-ontology namespace.</span>
<span class="sd">    :param list allowed_relationships: Optional - Filter graph to use only those relationships listed.</span>
<span class="sd">    :return: A Graph object of the ontology provided.</span>
<span class="sd">    :rtype: :py:obj:`class`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">database</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">database_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">godag</span><span class="o">.</span><span class="n">GoGraph</span><span class="p">(</span><span class="n">supergraph_namespace</span><span class="p">,</span> <span class="n">allowed_relationships</span><span class="p">)</span>
    <span class="n">go_parser</span> <span class="o">=</span> <span class="n">ontologyparser</span><span class="o">.</span><span class="n">GoParser</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">graph</span><span class="p">)</span>
    <span class="n">go_parser</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
    <span class="n">database</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">graph</span></div>


<div class="viewcode-block" id="create_subgraphs"><a class="viewcode-back" href="../../api.html#gocats.gocats.create_subgraphs">[docs]</a><span class="k">def</span> <span class="nf">create_subgraphs</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a graph object of an ontology, processed into :class:`gocats.dag.OboGraph` or to an object that</span>
<span class="sd">    inherits from :class:`gocats.dag.OboGraph`, and then extracts subgraphs which represent concepts that are defined</span>
<span class="sd">    by a list of provided keywords. Each subgraph is processed into :class:`gocats.subdag.SubGraph`.</span>

<span class="sd">    :param database_file: Ontology database file.</span>
<span class="sd">    :param keyword_file: A CSV file with two columns: column 1 naming categories, and column 2 listing search strings (no quotation marks, separated by semicolons).</span>
<span class="sd">    :param output_directory: The directory where results are stored.</span>
<span class="sd">    :param --supergraph_namespace=&lt;None&gt;: OPTIONAL-Specify a supergraph sub-ontology to filter e.g. cellular_component.</span>
<span class="sd">    :param --subgraph_namespace=&lt;None&gt;: OPTIONAL-Specify a subgraph sub-ontology to filter e.g. cellular_component.</span>
<span class="sd">    :param --supergraph_relationships=[]: OPTIONAL-Specify a list of relationships to limit in the supergraph e.g. [is_a, part_of].</span>
<span class="sd">    :param --subgraph_relationships=[]: OPTIONAL-Specify a list of relationships to limit in subgraphs e.g. [is_a, part_of].</span>
<span class="sd">    :param --map_supersets: OPTIONAL-Allow subgraphs to subsume other subgraphs.</span>
<span class="sd">    :param --output_termlist: OPTIONAL-Create a translation of ontology terms to their names to improve interpretability of dev test results.</span>
<span class="sd">    :return: None</span>
<span class="sd">    :rtype: :py:obj:`None`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--supergraph_namespace&#39;</span><span class="p">]:</span>
        <span class="n">supergraph_namespace</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--supergraph_namespace&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">supergraph_namespace</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--subgraph_namespace&#39;</span><span class="p">]:</span>
        <span class="n">subgraph_namespace</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--subgraph_namespace&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">subgraph_namespace</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--supergraph_relationships&#39;</span><span class="p">]:</span>
        <span class="n">supergraph_relationships</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--supergraph_relationships&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">supergraph_relationships</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--subgraph_relationships&#39;</span><span class="p">]:</span>
        <span class="n">subgraph_relationships</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--subgraph_relationships&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">subgraph_relationships</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Building the supergraph</span>
    <span class="n">database</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;database_file&gt;&#39;</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">output_directory</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;output_directory&gt;&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_directory</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_directory</span><span class="p">)</span>
    <span class="n">database_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;database_file&gt;&#39;</span><span class="p">])</span>
    <span class="n">graph_class</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go.obo&#39;</span><span class="p">:</span> <span class="n">godag</span><span class="o">.</span><span class="n">GoGraph</span><span class="p">(</span><span class="n">supergraph_namespace</span><span class="p">,</span> <span class="n">supergraph_relationships</span><span class="p">)}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">supergraph</span> <span class="o">=</span> <span class="n">graph_class</span><span class="p">[</span><span class="n">database_name</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The provided ontology filename was not recognized. Please do not rename ontology files. The accepted list of file names are as follows: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">graph_class</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    <span class="n">parsing_class</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;go.obo&#39;</span><span class="p">:</span> <span class="n">ontologyparser</span><span class="o">.</span><span class="n">GoParser</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">supergraph</span><span class="p">)}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">parsing_class</span><span class="p">[</span><span class="n">database_name</span><span class="p">]</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The provided ontology filename was not recognized. Please do not rename ontology files. The accepted list of file names are as follows: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">graph_class</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--output_termlist&#39;</span><span class="p">]:</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">jsonpickle_save</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">supergraph</span><span class="o">.</span><span class="n">id_index</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;output_directory&gt;&#39;</span><span class="p">],</span> <span class="s2">&quot;termlist&quot;</span><span class="p">))</span>

    <span class="n">id_translation</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">supergraph</span><span class="o">.</span><span class="n">id_index</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">id_translation</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span>
    <span class="n">tools</span><span class="o">.</span><span class="n">jsonpickle_save</span><span class="p">(</span><span class="n">id_translation</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;output_directory&gt;&#39;</span><span class="p">],</span> <span class="s2">&quot;id_translation&quot;</span><span class="p">))</span>

    <span class="n">database</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Building and collecting subgraphs</span>
    <span class="n">subgraph_collection</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;keyword_file&gt;&#39;</span><span class="p">],</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_MINIMAL</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
            <span class="n">subgraph_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">keyword_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">keyword</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
            <span class="n">subgraph_collection</span><span class="p">[</span><span class="n">subgraph_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">subdag</span><span class="o">.</span><span class="n">SubGraph</span><span class="o">.</span><span class="n">from_filtered_graph</span><span class="p">(</span><span class="n">supergraph</span><span class="p">,</span> <span class="n">keyword_list</span><span class="p">,</span> <span class="n">subgraph_namespace</span><span class="p">,</span> <span class="n">subgraph_relationships</span><span class="p">)</span>

    <span class="c1"># Handling superset mapping</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;--map_supersets&#39;</span><span class="p">]:</span>
        <span class="n">category_subsets</span> <span class="o">=</span> <span class="n">find_category_subsets</span><span class="p">(</span><span class="n">subgraph_collection</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NOTE: supersets were mapped.&quot;</span><span class="p">)</span>
        <span class="n">category_subsets</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">collection_id_mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">collection_node_mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">collection_content_mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">subgraph</span> <span class="ow">in</span> <span class="n">subgraph_collection</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">rep_node</span> <span class="ow">in</span> <span class="n">subgraph</span><span class="o">.</span><span class="n">root_id_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">collection_id_mapping</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">rep_node</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">collection_id_mapping</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">rep_node</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">rep_node</span> <span class="ow">in</span> <span class="n">subgraph</span><span class="o">.</span><span class="n">root_node_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">collection_node_mapping</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rep_node</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">collection_node_mapping</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">rep_node</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">rep_node</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">subgraph</span><span class="o">.</span><span class="n">content_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">collection_content_mapping</span><span class="p">[</span><span class="n">rep_node</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span>

    <span class="c1"># Remove root nodes that are subsets of existing root nodes from mapping</span>
    <span class="k">if</span> <span class="n">category_subsets</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">root_id_list</span> <span class="ow">in</span> <span class="n">collection_id_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">subset_id</span><span class="p">,</span> <span class="n">superset_ids</span> <span class="ow">in</span> <span class="n">category_subsets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">subset_id</span> <span class="ow">in</span> <span class="n">root_id_list</span><span class="p">:</span>
                    <span class="p">[</span><span class="n">root_id_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">superset_ids</span> <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">root_id_list</span><span class="p">]</span>
    <span class="c1"># TODO: do the same for node_object_mapping</span>

    <span class="c1"># Save mapping files and create report</span>
    <span class="n">tools</span><span class="o">.</span><span class="n">jsonpickle_save</span><span class="p">(</span><span class="n">collection_id_mapping</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;output_directory&gt;&#39;</span><span class="p">],</span> <span class="s2">&quot;GC_id_mapping&quot;</span><span class="p">))</span>
    <span class="n">tools</span><span class="o">.</span><span class="n">json_save</span><span class="p">(</span><span class="n">collection_id_mapping</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;output_directory&gt;&#39;</span><span class="p">],</span> <span class="s2">&quot;GC_id_mapping&quot;</span><span class="p">))</span>
    <span class="n">tools</span><span class="o">.</span><span class="n">jsonpickle_save</span><span class="p">(</span><span class="n">collection_content_mapping</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;output_directory&gt;&#39;</span><span class="p">],</span> <span class="s2">&quot;GC_content_mapping&quot;</span><span class="p">))</span>
    <span class="n">tools</span><span class="o">.</span><span class="n">json_save</span><span class="p">(</span><span class="n">collection_content_mapping</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;output_directory&gt;&#39;</span><span class="p">],</span> <span class="s2">&quot;GC_content_mapping&quot;</span><span class="p">))</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_directory</span><span class="p">,</span> <span class="s1">&#39;subgraph_report.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">report_file</span><span class="p">:</span>
        <span class="n">report_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="s1">&#39;Subgraph data</span><span class="se">\n</span><span class="s1">Supergraph filter: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">Subgraph filter: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">GO terms in the supergraph: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">GO terms in subgraphs: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">Relationship prevalence: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">supergraph_namespace</span><span class="p">,</span> <span class="n">subgraph_namespace</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">supergraph</span><span class="o">.</span><span class="n">node_list</span><span class="p">)),</span>
                <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">collection_id_mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">())),</span> <span class="n">supergraph</span><span class="o">.</span><span class="n">relationship_count</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">subgraph_name</span><span class="p">,</span> <span class="n">subgraph</span> <span class="ow">in</span> <span class="n">subgraph_collection</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">out_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                -------------------------</span>
<span class="s2">                </span><span class="si">{}</span><span class="s2"></span>
<span class="s2">                Subgraph relationships: </span><span class="si">{}</span><span class="s2"></span>
<span class="s2">                Seeded size: </span><span class="si">{}</span><span class="s2"></span>
<span class="s2">                Representative node: </span><span class="si">{}</span><span class="s2"></span>
<span class="s2">                Nodes added: </span><span class="si">{}</span><span class="s2"></span>
<span class="s2">                Non-subgraph hits (orphans): </span><span class="si">{}</span><span class="s2"></span>
<span class="s2">                Total nodes: </span><span class="si">{}</span><span class="s2"></span>
<span class="s2">                &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subgraph_name</span><span class="p">,</span> <span class="n">subgraph</span><span class="o">.</span><span class="n">relationship_count</span><span class="p">,</span> <span class="n">subgraph</span><span class="o">.</span><span class="n">seeded_size</span><span class="p">,</span>
                           <span class="n">subgraph</span><span class="o">.</span><span class="n">representative_node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">subgraph</span><span class="o">.</span><span class="n">node_list</span><span class="p">)</span> <span class="o">-</span> <span class="n">subgraph</span><span class="o">.</span><span class="n">seeded_size</span><span class="p">,</span>
                           <span class="nb">len</span><span class="p">(</span><span class="n">subgraph</span><span class="o">.</span><span class="n">node_list</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">subgraph</span><span class="o">.</span><span class="n">root_id_mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                           <span class="nb">len</span><span class="p">(</span><span class="n">subgraph</span><span class="o">.</span><span class="n">root_node_mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="n">report_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_string</span><span class="p">)</span>

    <span class="c1"># FIXME: cannot json save due to recursion of objects within objects...</span>
    <span class="c1"># tools.jsonpickle_save(collection_node_mapping, os.path.join(args[&#39;&lt;output_directory&gt;&#39;], &quot;GC_node_mapping&quot;))</span>

    <span class="c1"># Making a file for network visualization via Cytoscape 3.0</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;output_directory&gt;&#39;</span><span class="p">],</span> <span class="s2">&quot;NetworkTable.csv&quot;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">network_table</span><span class="p">:</span>
        <span class="n">edgewriter</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">network_table</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_MINIMAL</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">term_id</span><span class="p">,</span> <span class="n">root_id_list</span> <span class="ow">in</span> <span class="n">collection_id_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">root_id</span> <span class="ow">in</span> <span class="n">root_id_list</span><span class="p">:</span>
                <span class="n">edgewriter</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">term_id</span><span class="p">,</span> <span class="n">root_id</span><span class="p">])</span></div>


<div class="viewcode-block" id="find_category_subsets"><a class="viewcode-back" href="../../api.html#gocats.gocats.find_category_subsets">[docs]</a><span class="k">def</span> <span class="nf">find_category_subsets</span><span class="p">(</span><span class="n">subgraph_collection</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Finds subgraphs which are subsets of other subgraphs to remove redundancy, when specified.</span>

<span class="sd">    :param subgraph_collection: A dictionary of subgraph objects (keys: subgraph name, values: subgraph object).</span>
<span class="sd">    :return: A dictionary relating which subgraph objects are subsets of other subgraphs (keys: subset subgraph, values: superset subgraphs).</span>
<span class="sd">    :rtype: :py:obj:`dict`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">is_subset_of</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">subgraph</span> <span class="ow">in</span> <span class="n">subgraph_collection</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">next_subgraph</span> <span class="ow">in</span> <span class="n">subgraph_collection</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">subgraph</span><span class="o">.</span><span class="n">representative_node</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">next_subgraph</span><span class="o">.</span><span class="n">representative_node</span><span class="o">.</span><span class="n">id</span> <span class="ow">and</span> <span class="n">subgraph</span><span class="o">.</span><span class="n">representative_node</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">next_subgraph</span><span class="o">.</span><span class="n">root_id_mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">is_subset_of</span><span class="p">[</span><span class="n">subgraph</span><span class="o">.</span><span class="n">representative_node</span><span class="o">.</span><span class="n">id</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">next_subgraph</span><span class="o">.</span><span class="n">representative_node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">is_subset_of</span><span class="p">[</span><span class="n">subgraph</span><span class="o">.</span><span class="n">representative_node</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">next_subgraph</span><span class="o">.</span><span class="n">representative_node</span><span class="o">.</span><span class="n">id</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">is_subset_of</span></div>


<div class="viewcode-block" id="categorize_dataset"><a class="viewcode-back" href="../../api.html#gocats.gocats.categorize_dataset">[docs]</a><span class="k">def</span> <span class="nf">categorize_dataset</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads in a Gene Annotation File (GAF) and maps the annotations contained therein to the categories organized by</span>
<span class="sd">    GOcats or other methods. Outputs a mapped GAF and a list of unmapped genes in the specified output directory.</span>

<span class="sd">    :param dataset_file: A Gene Annotation File.</span>
<span class="sd">    :param term_mapping: A dictionary mapping category-defining ontology terms to their subgraph children terms. May be produced by GOcats or another method.</span>
<span class="sd">    :param output_directory: Specify the directory where the output file will be stored.</span>
<span class="sd">    :param mapped_dataset_filename: Specify the desired name of the mapped GAF.</span>
<span class="sd">    :return: None</span>
<span class="sd">    :rtype: :py:obj:`None`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">loaded_gaf_array</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">parse_gaf</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;dataset_file&gt;&#39;</span><span class="p">])</span>
    <span class="n">mapping_dict</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">jsonpickle_load</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;term_mapping&gt;&#39;</span><span class="p">])</span>
    <span class="n">output_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;output_directory&gt;&#39;</span><span class="p">])</span>
    <span class="n">mapped_dataset_filename</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;&lt;mapped_dataset_filename&gt;&#39;</span><span class="p">]</span>
    <span class="n">mapped_gaf_array</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">unmapped_genes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_directory</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_directory</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">loaded_gaf_array</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="ow">in</span> <span class="n">mapping_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">mapped_terms</span> <span class="o">=</span> <span class="n">mapping_dict</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">mapped_terms</span><span class="p">:</span>
                <span class="n">mapped_gaf_array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">term</span><span class="p">]</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">unmapped_genes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;NO_GENE:&#39;</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">unmapped_genes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">tools</span><span class="o">.</span><span class="n">write_out_gaf</span><span class="p">(</span><span class="n">mapped_gaf_array</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_directory</span><span class="p">,</span> <span class="n">mapped_dataset_filename</span><span class="p">))</span>
    <span class="n">tools</span><span class="o">.</span><span class="n">list_to_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_directory</span><span class="p">,</span> <span class="n">mapped_dataset_filename</span> <span class="o">+</span> <span class="s1">&#39;_unmappedGenes&#39;</span><span class="p">),</span> <span class="n">unmapped_genes</span><span class="p">)</span></div>
</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Eugene Hinderer.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.2.
    </div>
  </body>
</html>